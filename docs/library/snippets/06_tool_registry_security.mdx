````python 06_tool_registry_security.py
"""
Example 06: Tool registry security with sandbox policy.

Run:
    python 06_tool_registry_security.py
"""

from __future__ import annotations

import asyncio
from pathlib import Path

from pydantic import BaseModel, Field

from afk.tools import (
    SandboxProfile,
    ToolContext,
    ToolPolicyError,
    ToolRegistry,
    build_registry_output_limit_middleware,
    build_registry_sandbox_policy,
    tool,
)


class ReadArgs(BaseModel):
    path: str = Field(min_length=1)
    max_chars: int = Field(default=2000, ge=1, le=20_000)


@tool(
    args_model=ReadArgs,
    name="safe_read_file",
    description="Read a UTF-8 text file from an allowlisted path with max size bounds.",
)
def safe_read_file(args: ReadArgs, ctx: ToolContext) -> dict[str, str | bool]:
    _ = ctx
    target = Path(args.path).resolve()
    content = target.read_text(encoding="utf-8")
    truncated = len(content) > args.max_chars
    if truncated:
        content = content[: args.max_chars]
    return {"path": str(target), "content": content, "truncated": truncated}


async def main() -> None:
    cwd = Path.cwd()
    workspace = (cwd / ".afk_tools_security_demo").resolve()
    workspace.mkdir(parents=True, exist_ok=True)
    allowed_file = workspace / "allowed.txt"
    allowed_file.write_text("sandbox-safe demo content", encoding="utf-8")

    profile = SandboxProfile(
        profile_id="sdk-demo-sandbox",
        allow_network=False,
        allow_command_execution=False,
        allowed_paths=[str(workspace)],
        max_output_chars=4000,
    )

    registry = ToolRegistry(
        policy=build_registry_sandbox_policy(profile=profile, cwd=cwd),
        middlewares=[build_registry_output_limit_middleware(profile=profile)],
    )
    registry.register(safe_read_file)

    allowed = await registry.call(
        "safe_read_file",
        {"path": str(allowed_file)},
    )
    print("profile_id:", profile.profile_id)
    print("allowed_success:", allowed.success)

    try:
        await registry.call("safe_read_file", {"path": str(cwd / "outside-sandbox.txt")})
    except ToolPolicyError as exc:
        print("blocked_by_policy:", str(exc))


if __name__ == "__main__":
    asyncio.run(main())
````
